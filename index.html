<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebaseチャット</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      flex-direction: row;
    }
    #sidebar {
      width: 250px;
      background-color: #f4f4f4;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      border-bottom: 1px solid #ddd;
    }
    #message-form {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    .button, #send-button, #create-group-button, #join-group-button, #save-name-button, #auth-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.3s, box-shadow 0.3s;
      display: block;
    }
    .button:hover, #send-button:hover, #create-group-button:hover, #join-group-button:hover, #save-name-button:hover, #auth-button:hover {
      background: linear-gradient(45deg, #0056b3, #004080);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    #name-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #name-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    #name-input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: calc(100% - 22px);
      margin-bottom: 10px;
    }
    #group-container {
      padding: 10px;
      border-top: 1px solid #ddd;
      text-align: left;
    }
    #group-form {
      display: flex;
      flex-direction: column;
    }
    #group-name-input, #group-password-input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .group-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: linear-gradient(45deg, #ff8c00, #ff4500);
      color: white;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.3s, box-shadow 0.3s;
      display: block;
    }
    .group-button:hover {
      background: linear-gradient(45deg, #ff4500, #ff2400);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    #auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #auth-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    #auth-group-id-input, #auth-group-password-input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: calc(100% - 22px);
      margin-bottom: 10px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div id="sidebar">
    <div id="group-container">
      <form id="group-form">
        <input type="text" id="group-name-input" placeholder="グループ名を入力してください">
        <input type="password" id="group-password-input" placeholder="パスワードを入力してください">
        <button type="submit" id="create-group-button">グループ作成</button>
      </form>
      <button id="join-group-button">グループに参加</button>
    </div>
    <div id="current-group">
      <p>現在のグループ: <span id="current-group-name">なし</span></p>
    </div>
    <div id="group-history">
      <p>参加済みのグループ:</p>
      <!-- 参加済みのグループのボタンがここに追加されます -->
    </div>
  </div>
  <div id="chat-section">
    <div id="chat-container"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="メッセージを入力してください">
      <button type="submit" id="send-button">送信</button>
    </form>
  </div>
  <div id="name-container">
    <form id="name-form">
      <input type="text" id="name-input" placeholder="名前を入力してください">
      <button type="button" id="save-name-button">保存</button>
    </form>
  </div>
  <div id="auth-container">
    <form id="auth-form">
      <input type="text" id="auth-group-id-input" placeholder="グループIDを入力してください">
      <input type="password" id="auth-group-password-input" placeholder="パスワードを入力してください">
      <button type="submit" id="auth-button">認証</button>
    </form>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxFGXTPIp9HU7P3Jv9latfa_fZEb1anQ0",
      authDomain: "jjjjjjjjjjjjjjjj-d7ea6.firebaseapp.com",
      databaseURL: "https://jjjjjjjjjjjjjjjj-d7ea6-default-rtdb.firebaseio.com",
      projectId: "jjjjjjjjjjjjjjjj-d7ea6",
      storageBucket: "jjjjjjjjjjjjjjjj-d7ea6.appspot.com",
      messagingSenderId: "47669496508",
      appId: "1:47669496508:web:f2bb829d8811bd5f2f5eb9",
      measurementId: "G-MSNB77FVP5"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    document.addEventListener("DOMContentLoaded", function() {
      // DOM要素の取得
      const nameContainer = document.getElementById("name-container");
      const saveNameButton = document.getElementById("save-name-button");
      const nameInput = document.getElementById("name-input");
      const authContainer = document.getElementById("auth-container");
      const authForm = document.getElementById("auth-form");
      const authGroupIdInput = document.getElementById("auth-group-id-input");
      const authGroupPasswordInput = document.getElementById("auth-group-password-input");
      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-input");
      const chatContainer = document.getElementById("chat-container");
      const createGroupButton = document.getElementById("create-group-button");
      const joinGroupButton = document.getElementById("join-group-button");
      const groupNameInput = document.getElementById("group-name-input");
      const groupPasswordInput = document.getElementById("group-password-input");
      const currentGroupName = document.getElementById("current-group-name");
      const groupHistoryContainer = document.getElementById("group-history");

      let username = "";
      let currentGroupId = null;
      let joinedGroups = [];

      // 名前を保存する関数
      saveNameButton.addEventListener("click", () => {
        username = nameInput.value.trim();
        if (username) {
          nameContainer.style.display = "none";
        }
      });

      // グローバルチャットのメッセージをFirebaseデータベースに送信する関数
      function sendMessageToGlobalChat(message) {
        const globalMessagesRef = database.ref("globalMessages");
        const newMessageRef = globalMessagesRef.push();
        newMessageRef.set({
          username: username,
          message: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }

      // グローバルチャットのメッセージの変更を監視
      database.ref("globalMessages").on("child_added", (snapshot) => {
        const messageData = snapshot.val();
        displayMessage(messageData.username, messageData.message);
      });

      // メッセージ送信フォームの送信処理の変更
      messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
          if (currentGroupId === "global") {
            sendMessageToGlobalChat(message);
          } else {
            sendMessageToDatabase(message);
          }
          messageInput.value = "";
        }
      });

      // グループを作成する関数
      createGroupButton.addEventListener("click", (e) => {
        e.preventDefault();
        const groupName = groupNameInput.value.trim();
        const groupPassword = groupPasswordInput.value.trim();
        if (groupName && groupPassword) {
          const newGroupRef = database.ref("groups").push();
          const groupId = newGroupRef.key;
          newGroupRef.set({
            name: groupName,
            password: groupPassword
          }).then(() => {
            currentGroupId = groupId;
            currentGroupName.textContent = groupName;
            loadGroupMessages(groupId);
            joinedGroups.push(groupId); // 参加したグループをリストに追加
            saveJoinedGroups(); // グループ参加を保存
            addGroupButton(groupId, groupName); // グループボタンを追加
          });
        }
      });

      // グループに参加する関数
      joinGroupButton.addEventListener("click", () => {
        authContainer.style.display = "flex";
      });

      authForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const groupId = authGroupIdInput.value.trim();
        const groupPassword = authGroupPasswordInput.value.trim();
        if (groupId && groupPassword) {
          database.ref(`groups/${groupId}`).once("value", (snapshot) => {
            const groupData = snapshot.val();
            if (groupData && groupData.password === groupPassword) {
              currentGroupId = groupId;
              currentGroupName.textContent = groupData.name;
              authContainer.style.display = "none";
              loadGroupMessages(groupId);
              joinedGroups.push(groupId); // 参加したグループをリストに追加
              saveJoinedGroups(); // グループ参加を保存
              addGroupButton(groupId, groupData.name); // グループボタンを追加
            } else {
              alert("グループIDまたはパスワードが正しくありません");
            }
          });
        }
      });

      // グループのメッセージをFirebaseデータベースに送信する関数
      function sendMessageToDatabase(message) {
        const groupMessagesRef = database.ref(`groups/${currentGroupId}/messages`);
        const newMessageRef = groupMessagesRef.push();
        newMessageRef.set({
          username: username,
          message: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }

      // グループのメッセージをロードする関数
      function loadGroupMessages(groupId) {
        const groupMessagesRef = database.ref(`groups/${groupId}/messages`);
        groupMessagesRef.off("child_added");
        chatContainer.innerHTML = "";
        groupMessagesRef.on("child_added", (snapshot) => {
          const messageData = snapshot.val();
          displayMessage(messageData.username, messageData.message);
        });
      }

      // メッセージを表示する関数
      function displayMessage(username, message) {
        const messageElement = document.createElement("p");
        messageElement.textContent = `${username}: ${message}`;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // グループ参加の保存
      function saveJoinedGroups() {
        localStorage.setItem('joinedGroups', JSON.stringify(joinedGroups));
      }

      // グループ参加の復元
      function loadJoinedGroups() {
        const storedGroups = localStorage.getItem('joinedGroups');
        if (storedGroups) {
          joinedGroups = JSON.parse(storedGroups);
          if (!joinedGroups.includes("global")) {
            joinedGroups.push("global"); // グローバルチャットを参加済みリストに追加
          }
          joinedGroups.forEach(groupId => {
            if (groupId === "global") {
              addGroupButton(groupId, "グローバルチャット");
            } else {
              database.ref(`groups/${groupId}`).once("value", (snapshot) => {
                const groupData = snapshot.val();
                if (groupData) {
                  addGroupButton(groupId, groupData.name);
                }
              });
            }
          });
        }
      }

      // グループボタンを追加する関数
      function addGroupButton(groupId, groupName) {
        const groupButton = document.createElement("button");
        groupButton.textContent = groupName;
        groupButton.classList.add("group-button");
        groupButton.addEventListener("click", () => {
          joinGroup(groupId);
        });
        groupHistoryContainer.appendChild(groupButton);
      }

      // グループに参加する関数の変更
      function joinGroup(groupId) {
        if (joinedGroups.includes(groupId)) {
          alert("既にこのグループに参加しています");
          return;
        }
        if (groupId === "global") {
          currentGroupId = "global";
          currentGroupName.textContent = "グローバルチャット";
          loadGlobalChatMessages();
          return;
        }
        database.ref(`groups/${groupId}`).once("value", (snapshot) => {
          const groupData = snapshot.val();
          if (groupData) {
            currentGroupId = groupId;
            currentGroupName.textContent = groupData.name;
            authContainer.style.display = "none";
            loadGroupMessages(groupId);
            joinedGroups.push(groupId); // 参加したグループをリストに追加
            saveJoinedGroups(); // グループ参加を保存
          }
        });
      }

      // グローバルチャットのメッセージをロードする関数
      function loadGlobalChatMessages() {
        const globalMessagesRef = database.ref("globalMessages");
        globalMessagesRef.off("child_added");
        chatContainer.innerHTML = "";
        globalMessagesRef.on("child_added", (snapshot) => {
          const messageData = snapshot.val();
          displayMessage(messageData.username, messageData.message);
        });
      }

      // ページが読み込まれたときに参加済みグループを復元
      document.addEventListener("DOMContentLoaded", function() {
        loadJoinedGroups(); // 参加済みグループを復元
        addGroupButton("global", "グローバルチャット"); // グローバルチャットをグループリストに追加
      });

    });
  </script>
</body>
</html>
