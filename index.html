<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebaseチャット</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      flex-direction: row;
    }
    #sidebar {
      width: 250px;
      background-color: #f4f4f4;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      border-bottom: 1px solid #ddd;
    }
    #message-form {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    #send-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #28a745;
      color: white;
      cursor: pointer;
    }
    #name-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #name-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    #name-input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: calc(100% - 22px);
      margin-bottom: 10px;
    }
    #save-name-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    #group-container {
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    #group-form {
      display: flex;
      flex-direction: column;
    }
    #group-name-input, #group-password-input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    #create-group-button, #join-group-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      margin-bottom: 10px;
    }
    #current-group {
      margin-top: 20px;
    }
    #group-history {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
    }
    #group-history button {
      margin-bottom: 5px;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    #auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #auth-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    #auth-group-id-input, #auth-group-password-input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: calc(100% - 22px);
      margin-bottom: 10px;
    }
    #auth-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div id="sidebar">
    <div id="group-container">
      <form id="group-form">
        <input type="text" id="group-name-input" placeholder="グループ名を入力してください">
        <input type="password" id="group-password-input" placeholder="パスワードを入力してください">
        <button type="submit" id="create-group-button">グループ作成</button>
      </form>
      <button id="join-group-button">グループに参加</button>
    </div>
    <div id="current-group">
      <p>現在のグループ: <span id="current-group-name">なし</span></p>
    </div>
    <div id="group-history">
      <p>参加済みのグループ:</p>
    </div>
  </div>
  <div id="chat-section">
    <div id="chat-container"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="メッセージを入力してください">
      <button type="submit" id="send-button">送信</button>
    </form>
  </div>
  <div id="name-container">
    <form id="name-form">
      <input type="text" id="name-input" placeholder="名前を入力してください">
      <button type="button" id="save-name-button">保存</button>
    </form>
  </div>
  <div id="auth-container">
    <form id="auth-form">
      <input type="text" id="auth-group-id-input" placeholder="グループIDを入力してください">
      <input type="password" id="auth-group-password-input" placeholder="パスワードを入力してください">
      <button type="submit" id="auth-button">認証</button>
    </form>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    document.addEventListener("DOMContentLoaded", function() {
      const chatContainer = document.getElementById("chat-container");
      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-input");
      const nameContainer = document.getElementById("name-container");
      const nameForm = document.getElementById("name-form");
      const nameInput = document.getElementById("name-input");
      const saveNameButton = document.getElementById("save-name-button");

      const groupForm = document.getElementById("group-form");
      const groupNameInput = document.getElementById("group-name-input");
      const groupPasswordInput = document.getElementById("group-password-input");
      const joinGroupButton = document.getElementById("join-group-button");
      const authContainer = document.getElementById("auth-container");
      const authForm = document.getElementById("auth-form");
      const authGroupIdInput = document.getElementById("auth-group-id-input");
      const authGroupPasswordInput = document.getElementById("auth-group-password-input");

      const currentGroupName = document.getElementById("current-group-name");
      const groupHistory = document.getElementById("group-history");

      function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function addGroupToHistory(groupId, groupName) {
        let groupHistoryList = JSON.parse(getCookie("groupHistory") || "[]");
        groupHistoryList.push({ id: groupId, name: groupName });
        setCookie("groupHistory", JSON.stringify(groupHistoryList), 365);
        renderGroupHistory();
      }

      function renderGroupHistory() {
        groupHistory.innerHTML = "<p>参加済みのグループ:</p>";
        const groupHistoryList = JSON.parse(getCookie("groupHistory") || "[]");
        groupHistoryList.forEach(group => {
          const groupButton = document.createElement("button");
          groupButton.textContent = group.name;
          groupButton.addEventListener("click", function() {
            switchGroup(group.id, group.name);
          });
          groupHistory.appendChild(groupButton);
        });
      }

      function switchGroup(groupId, groupName) {
        setCookie("groupId", groupId, 365);
        currentGroupName.textContent = groupName;
        renderMessages(groupId);
      }

      let userName = getCookie("userName");
      let groupId = getCookie("groupId");

      if (!userName) {
        nameContainer.style.display = "flex";
      } else {
        if (groupId) {
          renderMessages(groupId);
        }
        renderGroupHistory();
      }

      saveNameButton.addEventListener("click", function() {
        userName = nameInput.value.trim();
        if (userName) {
          setCookie("userName", userName, 365);
          nameContainer.style.display = "none";
        }
      });

      messageForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (message && groupId) {
          const newMessageRef = database.ref("messages/" + groupId).push();
          newMessageRef.set({
            name: userName,
            message: message
          });
          messageInput.value = "";
        }
      });

      groupForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const groupName = groupNameInput.value.trim();
        const groupPassword = groupPasswordInput.value.trim();
        if (groupName && groupPassword) {
          groupId = generateRandomId();
          database.ref("groups/" + groupId).set({
            name: groupName,
            password: groupPassword
          });
          setCookie("groupId", groupId, 365);
          currentGroupName.textContent = groupName;
          renderMessages(groupId);
          addGroupToHistory(groupId, groupName);
          alert(`グループID: ${groupId}`);
        }
      });

      joinGroupButton.addEventListener("click", function() {
        authContainer.style.display = "flex";
      });

      authForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const inputGroupId = authGroupIdInput.value.trim();
        const inputGroupPassword = authGroupPasswordInput.value.trim();
        if (inputGroupId && inputGroupPassword) {
          database.ref("groups/" + inputGroupId).get().then(function(snapshot) {
            if (snapshot.exists() && snapshot.val().password === inputGroupPassword) {
              groupId = inputGroupId;
              setCookie("groupId", groupId, 365);
              currentGroupName.textContent = snapshot.val().name;
              renderMessages(groupId);
              addGroupToHistory(groupId, snapshot.val().name);
              authContainer.style.display = "none";
            } else {
              alert("グループIDまたはパスワードが正しくありません");
            }
          });
        }
      });

      function renderMessages(groupId) {
        chatContainer.innerHTML = "";
        database.ref("messages/" + groupId).on("child_added", function(snapshot) {
          const messageData = snapshot.val();
          const messageElement = document.createElement("div");
          messageElement.textContent = messageData.name + ": " + messageData.message;
          chatContainer.appendChild(messageElement);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
      }

      function generateRandomId() {
        return Math.random().toString(36).substr(2, 8);
      }
    });
  </script>
</body>
</html>
