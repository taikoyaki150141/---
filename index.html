<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebaseチャット</title>
  <style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    height: 100vh;
    flex-direction: row;
  }
  #sidebar {
    width: 250px;
    background-color: #f4f4f4;
    padding: 20px;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  #chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    border-bottom: 1px solid #ddd;
  }
  #message-form {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
  }
  #message-input {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-right: 10px;
  }
  .button, #send-button, #create-group-button, #join-group-button, #save-name-button, #auth-button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
    transition: background 0.3s, box-shadow 0.3s;
    display: block;
  }
  .button:hover, #send-button:hover, #create-group-button:hover, #join-group-button:hover, #save-name-button:hover, #auth-button:hover {
    background: linear-gradient(45deg, #0056b3, #004080);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  #name-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #name-form {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
  }
  #name-input {
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: calc(100% - 22px);
    margin-bottom: 10px;
  }
  #group-container {
    padding: 10px;
    border-top: 1px solid #ddd;
    text-align: left;
  }
  #group-form {
    display: flex;
    flex-direction: column;
  }
  #group-name-input, #group-password-input {
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  .group-button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    background: linear-gradient(45deg, #ff8c00, #ff4500);
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
    transition: background 0.3s, box-shadow 0.3s;
    display: block;
  }
  .group-button:hover {
    background: linear-gradient(45deg, #ff4500, #ff2400);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  #auth-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #auth-form {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
  }
  #auth-group-id-input, #auth-group-password-input {
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: calc(100% - 22px);
    margin-bottom: 10px;
  }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div id="sidebar">
    <div id="group-container">
      <form id="group-form">
        <input type="text" id="group-name-input" placeholder="グループ名を入力してください">
        <input type="password" id="group-password-input" placeholder="パスワードを入力してください">
        <button type="submit" id="create-group-button">グループ作成</button>
      </form>
      <button id="join-group-button">グループに参加</button>
    </div>
    <div id="current-group">
      <p>現在のグループ: <span id="current-group-name">なし</span></p>
    </div>
    <div id="group-history">
      <p>参加済みのグループ:</p>
      <!-- 参加済みのグループのボタンがここに追加されます -->
    </div>
  </div>
  <div id="chat-section">
    <div id="chat-container"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="メッセージを入力してください">
      <button type="submit" id="send-button">送信</button>
    </form>
  </div>
  <div id="name-container">
    <form id="name-form">
      <input type="text" id="name-input" placeholder="名前を入力してください">
      <button type="button" id="save-name-button">保存</button>
    </form>
  </div>
  <div id="auth-container">
    <form id="auth-form">
      <input type="text" id="auth-group-id-input" placeholder="グループIDを入力してください">
      <input type="password" id="auth-group-password-input" placeholder="パスワードを入力してください">
      <button type="submit" id="auth-button">認証</button>
    </form>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxFGXTPIp9HU7P3Jv9latfa_fZEb1anQ0",
      authDomain: "jjjjjjjjjjjjjjjj-d7ea6.firebaseapp.com",
      databaseURL: "https://jjjjjjjjjjjjjjjj-d7ea6-default-rtdb.firebaseio.com",
      projectId: "jjjjjjjjjjjjjjjj-d7ea6",
      storageBucket: "jjjjjjjjjjjjjjjj-d7ea6.appspot.com",
      messagingSenderId: "47669496508",
      appId: "1:47669496508:web:f2bb829d8811bd5f2f5eb9",
      measurementId: "G-MSNB77FVP5"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    document.addEventListener("DOMContentLoaded", function() {
      // DOM要素の取得
      const nameContainer = document.getElementById("name-container");
      const saveNameButton = document.getElementById("save-name-button");
      const nameInput = document.getElementById("name-input");
      const authContainer = document.getElementById("auth-container");
      const authForm = document.getElementById("auth-form");
      const authGroupIdInput = document.getElementById("auth-group-id-input");
      const authGroupPasswordInput = document.getElementById("auth-group-password-input");
      const groupForm = document.getElementById("group-form");
      const groupNameInput = document.getElementById("group-name-input");
      const groupPasswordInput = document.getElementById("group-password-input");
      const joinGroupButton = document.getElementById("join-group-button");
      const chatContainer = document.getElementById("chat-container");
      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-input");
      const currentGroupName = document.getElementById("current-group-name");
      const groupHistory = document.getElementById("group-history");

      // ユーザー名を保存するための変数
      let username = "";

      // ユーザーが名前を入力して保存ボタンをクリックしたときの処理
      saveNameButton.addEventListener("click", () => {
        username = nameInput.value.trim();
        if (username) {
          nameContainer.style.display = "none";
        }
      });

      // メッセージ送信フォームの送信処理
      messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
          sendMessageToDatabase(message);
          messageInput.value = "";
        }
      });

      // メッセージをFirebaseデータベースに送信する関数
      function sendMessageToDatabase(message) {
        const messagesRef = database.ref("messages");
        const newMessageRef = messagesRef.push();
        newMessageRef.set({
          username: username,
          message: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }

      // Firebaseデータベースのメッセージの変更を監視
      database.ref("messages").on("child_added", (snapshot) => {
        const messageData = snapshot.val();
        displayMessage(messageData.username, messageData.message);
      });

      // メッセージを画面に表示する関数
      function displayMessage(username, message) {
        const messageElement = document.createElement("div");
        messageElement.textContent = `${username}: ${message}`;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // グループ作成ボタンのクリック処理
      document.getElementById("create-group-button").addEventListener("click", (e) => {
        e.preventDefault();
        const groupName = groupNameInput.value.trim();
        const groupPassword = groupPasswordInput.value.trim();
        if (groupName && groupPassword) {
          createGroup(groupName, groupPassword);
        }
      });

      // グループ参加ボタンのクリック処理
      joinGroupButton.addEventListener("click", () => {
        authContainer.style.display = "flex";
      });

      // グループ認証ボタンのクリック処理
      authForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const groupId = authGroupIdInput.value.trim();
        const groupPassword = authGroupPasswordInput.value.trim();
        if (groupId && groupPassword) {
          authenticateGroup(groupId, groupPassword);
        }
      });

      // ランダムな短いグループIDを生成する関数
      function generateShortGroupId() {
        return Math.random().toString(36).substr(2, 6); // 6文字のランダムなIDを生成
      }

      // ユーザーが参加しているグループIDを保存するリスト
      let joinedGroups = [];

      // グループを作成する関数
      function createGroup(groupName, groupPassword) {
        const groupsRef = database.ref("groups");
        const newGroupId = generateShortGroupId();
        const newGroupRef = groupsRef.child(newGroupId);
        newGroupRef.set({
          name: groupName,
          password: groupPassword
        }).then(() => {
          alert(`グループが作成されました。グループID: ${newGroupId}`);
          joinGroup(newGroupId);
          addGroupButton(newGroupId, groupName); // グループ作成時にボタンを追加
        });
      }

      // グループに参加する関数
      function joinGroup(groupId) {
        if (joinedGroups.includes(groupId)) {
          alert("既にこのグループに参加しています");
          return;
        }
        database.ref(`groups/${groupId}`).once("value", (snapshot) => {
          const groupData = snapshot.val();
          if (groupData) {
            currentGroupName.textContent = groupData.name;
            authContainer.style.display = "none";
            loadGroupMessages(groupId);
            joinedGroups.push(groupId); // 参加したグループをリストに追加
          }
        });
      }

      // グループのメッセージを読み込む関数
      function loadGroupMessages(groupId) {
        database.ref(`groups/${groupId}/messages`).on("child_added", (snapshot) => {
          const messageData = snapshot.val();
          displayMessage(messageData.username, messageData.message);
        });
      }

      // グループを認証する関数
      function authenticateGroup(groupId, groupPassword) {
        database.ref(`groups/${groupId}`).once("value", (snapshot) => {
          const groupData = snapshot.val();
          if (groupData && groupData.password === groupPassword) {
            joinGroup(groupId);
            addGroupButton(groupId, groupData.name); // 認証後にボタンを追加
          } else {
            alert("グループIDまたはパスワードが間違っています");
          }
        });
      }

      // 参加済みグループのボタンを追加する関数
      function addGroupButton(groupId, groupName) {
        if (joinedGroups.includes(groupId)) return; // 既に参加しているグループの場合はボタンを追加しない
        const button = document.createElement("button");
        button.textContent = groupName;
        button.classList.add("group-button");
        button.addEventListener("click", () => {
          joinGroup(groupId);
        });
        groupHistory.appendChild(button);
      }

      // 認証画面外をクリックしたときに閉じる処理
      window.addEventListener("click", (event) => {
        if (event.target === authContainer) {
          authContainer.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
